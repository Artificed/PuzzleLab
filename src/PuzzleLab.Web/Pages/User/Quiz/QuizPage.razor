@page "/quiz/{QuizId:guid}"
@using PuzzleLab.Shared.DTOs.QuizSession
@using PuzzleLab.Web.Services.Api.Core.Interfaces
@using PuzzleLab.Web.Services.State
@using PuzzleLab.Web.Services.Ui

@using PuzzleLab.Web.Services.Time
@using Microsoft.Extensions.Logging

@using System.Timers
@using PuzzleLab.Shared.DTOs.QuizAnswer.Requests
@using PuzzleLab.Shared.DTOs.QuizSchedule.Requests
@using PuzzleLab.Shared.DTOs.QuizSession.Requests
@using PuzzleLab.Web.Services.Api.Core.Implementations

@layout Components.Layout.UserLayout

@inject IQuizScheduleService QuizScheduleService
@inject IQuizSessionService QuizSessionService
@inject IQuizAnswerService QuizAnswerService
@inject NavigationManager NavigationManager
@inject UserStateService UserState

@inject IServerTimeService ServerTimeService

@rendermode InteractiveServer

<PageTitle>Quiz - PuzzleLab</PageTitle>

<div class="w-full max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 mb-6">
    @if (_isLoading)
    {
        <LoadingSpinner/>
    }
    else if (_quizError)
    {
        <QuizError ErrorMessage="@_errorMessage" OnNavigateToDashboard="NavigateToUserDashboard"/>
    }
    else
    {
        <div class="bg-white shadow-sm rounded-lg border border-gray-200 overflow-hidden">
            <QuizHeader
                Title="@_quizTitle"
                CurrentQuestion="@(_currentQuestionIndex + 1)"
                TotalQuestions="@_totalQuestions"
                StartedAt="@(_quizSession?.StartedAt ?? DateTime.Now)"
                TimeRemaining="@_displayTimeRemaining"
                Status="@(_quizSession?.Status ?? "Active")"
                OnExitClick="ShowExitConfirmation"/>

            <ProgressBar Current="@(_currentQuestionIndex + 1)" Total="@_totalQuestions"/>

            @if (_currentQuestion != null)
            {
                <QuestionDisplay
                    Question="@_currentQuestion"
                    SelectedAnswerIndex="@_selectedAnswerIndex"
                    OnAnswerSelected="SelectAnswer"/>
            }

            <NavigationButtons
                CurrentIndex="@_currentQuestionIndex"
                TotalQuestions="@_totalQuestions"
                OnPrevious="PreviousQuestion"
                OnNext="NextQuestion"
                OnSubmit="ShowSubmitConfirmation"/>
        </div>

        <QuestionNavigator
            CurrentIndex="@_currentQuestionIndex"
            TotalQuestions="@_totalQuestions"
            AnsweredQuestions="@_answeredQuestions"
            SessionId="@(_quizSession?.Id.ToString() ?? "Loading...")"
            OnQuestionSelected="JumpToQuestion"/>
    }
</div>

<ConfirmationDialog
    IsVisible="@_showExitConfirmation"
    Title="Exit Quiz"
    Message="Are you sure you want to exit the quiz? Your current progress will be saved, but if the quiz has a time limit, the timer will continue to run."
    ConfirmButtonText="Exit Quiz"
    ConfirmButtonClass="bg-red-600 hover:bg-red-700"
    OnCancel="CancelExit"
    OnConfirm="ConfirmExit"/>

<ConfirmationDialog
    IsVisible="@_showSubmitConfirmation"
    Title="Submit Quiz"
    Message="@($"Are you sure you want to submit your quiz? You've answered {_answeredQuestions.Count} out of {_totalQuestions} questions.")"
    ConfirmButtonText="Submit Quiz"
    ConfirmButtonClass="bg-green-600 hover:bg-green-700"
    OnCancel="CancelSubmit"
    OnConfirm="ConfirmSubmitQuiz">
    @if (_answeredQuestions.Count < _totalQuestions)
    {
        <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md">
            <p class="text-sm text-yellow-800">
                Warning: You have @(_totalQuestions - _answeredQuestions.Count) unanswered questions.
                Once submitted, you won't be able to change your answers.
            </p>
        </div>
    }
</ConfirmationDialog>

@code {
    [Parameter] public Guid QuizId { get; set; }

    private bool _isLoading = true;
    private bool _quizError = false;
    private string _errorMessage = string.Empty;
    private string _quizTitle = "Sample Quiz";
    private int _currentQuestionIndex = 0;
    private int _totalQuestions = 0;
    private int _selectedAnswerIndex = -1;
    private Dictionary<int, int> _answeredQuestions = new Dictionary<int, int>();
    private QuestionWithAnswerDto? _currentQuestion;
    private QuizSessionDto? _quizSession;
    private TimeSpan _timeRemaining;
    private bool _showExitConfirmation = false;
    private bool _showSubmitConfirmation = false;

    private bool _isQuizFinished = false;
    private bool _isAutoSubmitting = false;

    private DateTimeOffset? _quizEndTimeUtc;
    private TimeSpan _displayTimeRemaining = TimeSpan.MaxValue;
    private string _timeSyncStatus = "Syncing...";

    private Dictionary<int, Guid> _questionIdMap = new Dictionary<int, Guid>();
    private Dictionary<Guid, int> _questionIdToAnswerIndexMap = new Dictionary<Guid, int>();
    private bool _isCurrentAnswerSaved = true;
    private Dictionary<Guid, Guid> _questionIdToSelectedAnswerIdMap = new Dictionary<Guid, Guid>();

    protected override async Task OnInitializedAsync()
    {
        ServerTimeService.TimeUpdated += HandleServerTimeUpdate;
        UpdateRemainingTimeDisplay();
        try
        {
            if (UserState?.CurrentUser?.Id is null)
            {
                ToastService.ShowError("User is not logged in.", "Error");
                NavigationManager.NavigateTo("/login");
                return;
            }

            var request = new CreateOrGetQuizSessionRequest() { QuizId = QuizId, };
            var response = await QuizSessionService.CreateOrGetQuizSessionAsync(request);

            if (response is null)
            {
                ToastService.ShowError("Failed to create quiz session.", "Error");
                return;
            }

            _quizSession = response.QuizSessionDto;
            _totalQuestions = _quizSession.TotalQuestions;

            if (_quizSession.Status.Equals("Finalized", StringComparison.OrdinalIgnoreCase))
            {
                _isQuizFinished = true;
                _isLoading = false;
                ToastService.ShowInfo("This quiz session has already been finalized.", "Quiz Finished");
                NavigateToUserDashboard();
                return;
            }

            if (_quizSession.Id != Guid.Empty)
            {
                await LoadQuizEndTime();
                await LoadSavedAnswers();
                await LoadQuestionMappings();
            }

            await LoadCurrentQuestion();

            _isLoading = false;
        }
        catch (Exception ex)
        {
            _isLoading = false;
            _quizError = true;
            _errorMessage = ex.Message;
        }
    }

    private async Task LoadSavedAnswers()
    {
        try
        {
            if (_quizSession == null) return;

            var request = new GetQuizAnswersBySessionRequest()
            {
                SessionId = _quizSession.Id
            };
            var savedAnswersResponse = await QuizAnswerService.GetQuizAnswersBySessionIdAsync(request);

            if (savedAnswersResponse != null && savedAnswersResponse.SaveQuizAnswerDtos.Count > 0)
            {
                foreach (var savedAnswer in savedAnswersResponse.SaveQuizAnswerDtos)
                {
                    Guid questionId = savedAnswer.QuestionId;
                    Guid selectedAnswerId = savedAnswer.SelectedAnswerId;

                    _questionIdToSelectedAnswerIdMap[questionId] = selectedAnswerId;
                }
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to load saved answers: {ex.Message}", "Error");
        }
    }

    private async Task LoadQuestionMappings()
    {
        for (int i = 0; i < _totalQuestions; i++)
        {
            var request = new GetCurrentQuestionRequest
            {
                QuizId = QuizId.ToString(),
                QuestionIndex = i
            };

            var response = await QuizSessionService.GetCurrentQuestionAsync(request);
            if (response != null && response.QuestionWithAnswerDto != null)
            {
                var question = response.QuestionWithAnswerDto;
                _questionIdMap[i] = question.Id;

                if (_questionIdToSelectedAnswerIdMap.ContainsKey(question.Id))
                {
                    var savedAnswerId = _questionIdToSelectedAnswerIdMap[question.Id];

                    for (int j = 0; j < question.Answers.Length; j++)
                    {
                        if (question.Answers[j].Id == savedAnswerId)
                        {
                            _answeredQuestions[i] = j;
                            break;
                        }
                    }
                }
            }
        }

        StateHasChanged();
    }

    private void HandleServerTimeUpdate()
    {
        InvokeAsync(() =>
        {
            UpdateRemainingTimeDisplay();
            StateHasChanged();
        });
    }

    private void UpdateRemainingTimeDisplay()
    {
        if (_isQuizFinished)
        {
            _displayTimeRemaining = TimeSpan.Zero;
            _timeSyncStatus = "Finished";
            return;
        }

        if (_quizEndTimeUtc.HasValue)
        {
            if (ServerTimeService.CurrentServerTimeUtc.HasValue)
            {
                var serverTime = ServerTimeService.CurrentServerTimeUtc.Value;
                var remaining = _quizEndTimeUtc.Value - serverTime;

                if (remaining <= TimeSpan.Zero)
                {
                    _displayTimeRemaining = TimeSpan.Zero;
                    _timeSyncStatus = "Time Expired";
                    if (!_isQuizFinished && !_isAutoSubmitting)
                    {
                        InvokeAsync(AutoSubmitQuiz);
                    }
                }
                else
                {
                    _displayTimeRemaining = remaining;
                    _timeSyncStatus = "Synced";
                }
            }
            else
            {
                _displayTimeRemaining = TimeSpan.MaxValue;
                _timeSyncStatus = "Syncing...";
            }
        }
        else
        {
            _displayTimeRemaining = TimeSpan.MaxValue;
            _timeSyncStatus = "Waiting for end time...";
        }
    }

    private void SelectAnswer(int answerIndex)
    {
        if (_isQuizFinished) return;

        _selectedAnswerIndex = answerIndex;
        _answeredQuestions[_currentQuestionIndex] = answerIndex;

        if (_currentQuestion != null && _questionIdMap.ContainsKey(_currentQuestionIndex))
        {
            _questionIdToAnswerIndexMap[_currentQuestion.Id] = answerIndex;
        }

        _isCurrentAnswerSaved = false;
        StateHasChanged();
    }

    private async Task SaveCurrentAnswer()
    {
        if (_answeredQuestions.ContainsKey(_currentQuestionIndex) && !_isCurrentAnswerSaved && _quizSession != null && _currentQuestion != null)
        {
            try
            {
                int answerIndex = _answeredQuestions[_currentQuestionIndex];

                Guid selectedAnswerId = _currentQuestion.Answers[answerIndex].Id;

                var request = new SaveQuizAnswerRequest()
                {
                    SessionId = _quizSession.Id,
                    QuestionId = _currentQuestion.Id,
                    Answer = selectedAnswerId.ToString()
                };

                var response = await QuizAnswerService.SaveQuizAnswerAsync(request);

                if (response is null)
                {
                    ToastService.ShowError("Failed to save answer!", "Error");
                }
                else
                {
                    _questionIdToSelectedAnswerIdMap[_currentQuestion.Id] = selectedAnswerId;
                    _isCurrentAnswerSaved = true;
                }
            }
            catch (Exception e)
            {
                ToastService.ShowError($"Failed to save answer! {e}", "Error");
            }
        }
    }

    private async Task NextQuestion()
    {
        await SaveCurrentAnswer();

        if (_currentQuestionIndex < _totalQuestions - 1)
        {
            _currentQuestionIndex++;
            await LoadCurrentQuestion();
        }
    }

    private async Task PreviousQuestion()
    {
        await SaveCurrentAnswer();

        if (_currentQuestionIndex > 0)
        {
            _currentQuestionIndex--;
            await LoadCurrentQuestion();
        }
    }

    private async Task JumpToQuestion(int questionIndex)
    {
        await SaveCurrentAnswer();

        if (questionIndex >= 0 && questionIndex < _totalQuestions)
        {
            _currentQuestionIndex = questionIndex;
            await LoadCurrentQuestion();
        }
    }

    private async Task LoadQuizEndTime()
    {
        var request = new GetQuizEndTimeRequest()
        {
            QuizId = QuizId
        };

        var response = await QuizScheduleService.GetQuizEndTimeAsync(request);
        if (response != null)
        {
            _quizEndTimeUtc = response.EndTime;
            UpdateRemainingTimeDisplay();
        }
        else
        {
            ToastService.ShowError("Failed to load quiz end time!", "Error");
        }
    }

    private async Task LoadCurrentQuestion()
    {
        var request = new GetCurrentQuestionRequest
        {
            QuizId = QuizId.ToString(),
            QuestionIndex = _currentQuestionIndex
        };
        var response = await QuizSessionService.GetCurrentQuestionAsync(request);

        if (response is null)
        {
            ToastService.ShowError("Failed to fetch question!", "Error");
            return;
        }

        _currentQuestion = response.QuestionWithAnswerDto;

        if (_currentQuestion != null)
        {
            _questionIdMap[_currentQuestionIndex] = _currentQuestion.Id;
            _selectedAnswerIndex = -1;

            if (_questionIdToSelectedAnswerIdMap.ContainsKey(_currentQuestion.Id))
            {
                Guid savedAnswerId = _questionIdToSelectedAnswerIdMap[_currentQuestion.Id];

                for (int i = 0; i < _currentQuestion.Answers.Length; i++)
                {
                    if (_currentQuestion.Answers[i].Id == savedAnswerId)
                    {
                        _selectedAnswerIndex = i;
                        _answeredQuestions[_currentQuestionIndex] = i;
                        break;
                    }
                }

                _isCurrentAnswerSaved = true;
            }
            else if (_answeredQuestions.ContainsKey(_currentQuestionIndex))
            {
                _selectedAnswerIndex = _answeredQuestions[_currentQuestionIndex];
                _isCurrentAnswerSaved = false;
            }
            else
            {
                _selectedAnswerIndex = -1;
                _isCurrentAnswerSaved = true;
            }

            StateHasChanged();
        }
    }

    private void ShowExitConfirmation()
    {
        _showExitConfirmation = true;
    }

    private void CancelExit()
    {
        _showExitConfirmation = false;
    }

    private async Task ConfirmExit()
    {
        await SaveCurrentAnswer();
        NavigateToUserDashboard();
    }

    private void NavigateToUserDashboard()
    {
        CleanupResources();
        NavigationManager.NavigateTo("/user/dashboard");
    }

    private void ShowSubmitConfirmation()
    {
        _showSubmitConfirmation = true;
    }

    private void CancelSubmit()
    {
        _showSubmitConfirmation = false;
    }

    private async Task ConfirmSubmitQuiz()
    {
        _showSubmitConfirmation = false;
        await SubmitQuiz("Manual");
    }

    private async Task AutoSubmitQuiz()
    {
        if (_isQuizFinished || _isAutoSubmitting) return;

        _isAutoSubmitting = true;
        ToastService.ShowInfo("Time is up! Submitting your quiz automatically.", "Auto Submit");
        await SubmitQuiz("AutoSubmit");
        _isAutoSubmitting = false;
    }

    private async Task SubmitQuiz(string submissionType)
    {
        _isLoading = true;
        _isQuizFinished = true;
        await InvokeAsync(StateHasChanged);

        await SaveCurrentAnswer();

        try
        {
            if (_quizSession is null)
            {
                return;
            }

            var request = new FinalizeQuizRequest() { SessionId = _quizSession.Id };
            var response = await QuizSessionService.FinalizeQuizAsync(request);

            if (response == null)
            {
                ToastService.ShowError($"Failed to finalize quiz submission on the server.", "Submission Error");
                _isLoading = false;
                _quizError = true;
                _errorMessage = "Failed to submit quiz to server. Please contact support.";
                await InvokeAsync(StateHasChanged);
            }
            else
            {
                ToastService.ShowSuccess($"Quiz submitted successfully!", "Success");
                NavigateToUserDashboard();
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Error occurred while submitting the quiz.", "Error");
        }
        finally
        {
            if (_isLoading) _isLoading = false;
            CleanupResources();
            await InvokeAsync(StateHasChanged);
        }
    }

    private void CleanupResources()
    {
        ServerTimeService.TimeUpdated -= HandleServerTimeUpdate;
    }


    public async ValueTask DisposeAsync()
    {
        CleanupResources();
        await ValueTask.CompletedTask;
        GC.SuppressFinalize(this);
    }

}